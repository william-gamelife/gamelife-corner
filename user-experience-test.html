<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GameLife 使用者體驗測試</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #f4f1eb 0%, #e8e2d5 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .test-header {
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }
        
        .user-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .user-card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
        }
        
        .user-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
        }
        
        .user-card.selected {
            border-color: #c9a961;
            background: linear-gradient(135deg, #fff 0%, #fefcf8 100%);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #c9a961, #7a8b74);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: 600;
        }
        
        .user-details h3 {
            color: #3a3833;
            font-size: 20px;
            margin-bottom: 4px;
        }
        
        .user-role {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            color: white;
        }
        
        .role-super { background: #e74c3c; }
        .role-business { background: #3498db; }
        .role-general { background: #2ecc71; }
        
        .user-permissions {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        .permission-title {
            font-size: 14px;
            font-weight: 600;
            color: #666;
            margin-bottom: 8px;
        }
        
        .permission-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        
        .permission-tag {
            padding: 4px 8px;
            background: #f8f9fa;
            border-radius: 12px;
            font-size: 11px;
            color: #666;
        }
        
        .permission-tag.allowed {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .permission-tag.denied {
            background: #ffebee;
            color: #c62828;
        }
        
        .test-section {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #3a3833;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .login-form {
            display: none;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-top: 15px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }
        
        .form-group input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #c9a961;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: #c9a961;
            color: white;
        }
        
        .btn-primary:hover {
            background: #b5976e;
        }
        
        .test-results {
            margin-top: 20px;
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 8px;
            background: #f8f9fa;
        }
        
        .result-success {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .result-error {
            background: #ffebee;
            color: #c62828;
        }
        
        .module-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .module-item {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
            font-size: 12px;
            border: 2px solid transparent;
        }
        
        .module-item.accessible {
            background: #e8f5e9;
            color: #2e7d32;
            border-color: #c8e6c9;
        }
        
        .module-item.restricted {
            background: #ffebee;
            color: #c62828;
            border-color: #ffcdd2;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="test-header">
            <h1>🎮 GameLife 使用者體驗測試</h1>
            <p>模擬不同權限使用者的完整操作流程</p>
        </div>

        <!-- 使用者選擇卡片 -->
        <div class="user-cards">
            <div class="user-card" onclick="selectUser('william')" id="card-william">
                <div class="user-info">
                    <div class="user-avatar">威</div>
                    <div class="user-details">
                        <h3>威廉 (William)</h3>
                        <span class="user-role role-super">超級管理員</span>
                    </div>
                </div>
                <div class="user-permissions">
                    <div class="permission-title">權限範圍:</div>
                    <div class="permission-list">
                        <span class="permission-tag allowed">人員管理</span>
                        <span class="permission-tag allowed">所有模組</span>
                        <span class="permission-tag allowed">系統設定</span>
                        <span class="permission-tag allowed">專案打包</span>
                    </div>
                </div>
                <div class="login-form" id="form-william">
                    <div class="form-group">
                        <label>帳號:</label>
                        <input type="text" value="william" readonly>
                    </div>
                    <div class="form-group">
                        <label>密碼:</label>
                        <input type="password" id="password-william" placeholder="輸入密碼">
                    </div>
                    <button class="btn btn-primary" onclick="testLogin('william')">登入測試</button>
                </div>
            </div>

            <div class="user-card" onclick="selectUser('carson')" id="card-carson">
                <div class="user-info">
                    <div class="user-avatar">C</div>
                    <div class="user-details">
                        <h3>Carson</h3>
                        <span class="user-role role-business">商務管理員</span>
                    </div>
                </div>
                <div class="user-permissions">
                    <div class="permission-title">權限範圍:</div>
                    <div class="permission-list">
                        <span class="permission-tag denied">人員管理</span>
                        <span class="permission-tag allowed">業務模組</span>
                        <span class="permission-tag allowed">部分設定</span>
                        <span class="permission-tag allowed">專案打包</span>
                    </div>
                </div>
                <div class="login-form" id="form-carson">
                    <div class="form-group">
                        <label>帳號:</label>
                        <input type="text" value="carson" readonly>
                    </div>
                    <div class="form-group">
                        <label>密碼:</label>
                        <input type="password" id="password-carson" placeholder="輸入密碼">
                    </div>
                    <button class="btn btn-primary" onclick="testLogin('carson')">登入測試</button>
                </div>
            </div>

            <div class="user-card" onclick="selectUser('kai')" id="card-kai">
                <div class="user-info">
                    <div class="user-avatar">K</div>
                    <div class="user-details">
                        <h3>KAI</h3>
                        <span class="user-role role-general">一般使用者</span>
                    </div>
                </div>
                <div class="user-permissions">
                    <div class="permission-title">權限範圍:</div>
                    <div class="permission-list">
                        <span class="permission-tag denied">人員管理</span>
                        <span class="permission-tag denied">專案管理</span>
                        <span class="permission-tag allowed">基本功能</span>
                        <span class="permission-tag denied">專案打包</span>
                    </div>
                </div>
                <div class="login-form" id="form-kai">
                    <div class="form-group">
                        <label>帳號:</label>
                        <input type="text" value="kai" readonly>
                    </div>
                    <div class="form-group">
                        <label>密碼:</label>
                        <input type="password" id="password-kai" placeholder="輸入密碼">
                    </div>
                    <button class="btn btn-primary" onclick="testLogin('kai')">登入測試</button>
                </div>
            </div>
        </div>

        <!-- 測試結果區域 -->
        <div class="test-section" id="login-results" style="display: none;">
            <div class="section-title">
                🔐 登入測試結果
            </div>
            <div class="test-results" id="login-status"></div>
        </div>

        <div class="test-section" id="module-access" style="display: none;">
            <div class="section-title">
                📱 模組存取測試
            </div>
            <div class="module-grid" id="module-list"></div>
        </div>

        <div class="test-section" id="permission-tests" style="display: none;">
            <div class="section-title">
                ⚙️ 功能權限測試
            </div>
            <div class="test-results" id="permission-results"></div>
        </div>
    </div>

    <!-- 載入權限系統 -->
    <script src="./permission-helper.js"></script>
    <script src="./auth-bridge.js"></script>

    <script>
        let selectedUser = null;
        let currentUser = null;

        // 預設密碼
        const defaultPasswords = {
            william: 'pass1234',
            carson: 'pass1234',
            kai: 'pass1234'
        };

        function selectUser(username) {
            // 清除之前的選擇
            document.querySelectorAll('.user-card').forEach(card => {
                card.classList.remove('selected');
                card.querySelector('.login-form').style.display = 'none';
            });

            // 選擇新使用者
            const card = document.getElementById(`card-${username}`);
            const form = document.getElementById(`form-${username}`);
            
            card.classList.add('selected');
            form.style.display = 'block';

            // 自動填入預設密碼以便測試
            const passwordInput = document.getElementById(`password-${username}`);
            passwordInput.value = defaultPasswords[username];

            selectedUser = username;

            // 隱藏測試結果
            hideTestResults();
        }

        async function testLogin(username) {
            const password = document.getElementById(`password-${username}`).value;
            
            if (!password) {
                alert('請輸入密碼');
                return;
            }

            try {
                console.log('測試登入:', username, password);
                
                // 使用權限系統驗證
                const permissionHelper = getPermissionHelper();
                const user = permissionHelper.validateUser(username, password);

                if (user) {
                    currentUser = user;
                    showLoginSuccess(user);
                    testModuleAccess(user);
                    testPermissions(user);
                } else {
                    showLoginError('登入失敗：帳號或密碼錯誤');
                }
            } catch (error) {
                console.error('登入測試錯誤:', error);
                showLoginError('系統錯誤：' + error.message);
            }
        }

        function showLoginSuccess(user) {
            const resultsDiv = document.getElementById('login-results');
            const statusDiv = document.getElementById('login-status');
            
            statusDiv.innerHTML = `
                <div class="result-item result-success">
                    <span>✅ 登入成功</span>
                    <span>${user.displayName} (${user.role})</span>
                </div>
                <div class="result-item">
                    <span>UUID:</span>
                    <span>${user.uuid}</span>
                </div>
                <div class="result-item">
                    <span>權限等級:</span>
                    <span>${getRoleLevel(user.role)}</span>
                </div>
            `;
            
            resultsDiv.style.display = 'block';
        }

        function showLoginError(message) {
            const resultsDiv = document.getElementById('login-results');
            const statusDiv = document.getElementById('login-status');
            
            statusDiv.innerHTML = `
                <div class="result-item result-error">
                    <span>❌ ${message}</span>
                </div>
            `;
            
            resultsDiv.style.display = 'block';
        }

        function testModuleAccess(user) {
            const permissionHelper = getPermissionHelper();
            const allModules = [
                'users', 'overview', 'todos', 'calendar', 'finance',
                'projects', 'timebox', 'life-simulator', 'pixel-life',
                'travel-pdf', 'settings', 'themes', 'sync', 'permissions'
            ];

            const moduleListDiv = document.getElementById('module-list');
            const accessDiv = document.getElementById('module-access');
            
            let moduleHTML = '';
            
            allModules.forEach(module => {
                const canAccess = permissionHelper.canAccessModule(user.uuid, module);
                const canModify = permissionHelper.canModifyModule(user.uuid, module);
                const canDelete = permissionHelper.canDeleteFromModule(user.uuid, module);
                
                const accessClass = canAccess ? 'accessible' : 'restricted';
                const accessText = canAccess ? '✅' : '❌';
                const permissionText = canAccess ? 
                    `讀${canAccess ? '✓' : '✗'} 寫${canModify ? '✓' : '✗'} 刪${canDelete ? '✓' : '✗'}` : 
                    '無權限';
                
                moduleHTML += `
                    <div class="module-item ${accessClass}">
                        <div style="font-weight: 600;">${module}</div>
                        <div>${accessText}</div>
                        <div style="font-size: 10px; margin-top: 4px;">${permissionText}</div>
                    </div>
                `;
            });
            
            moduleListDiv.innerHTML = moduleHTML;
            accessDiv.style.display = 'block';
        }

        function testPermissions(user) {
            const permissionHelper = getPermissionHelper();
            const resultsDiv = document.getElementById('permission-results');
            const sectionDiv = document.getElementById('permission-tests');
            
            // 測試特殊功能
            const canPackage = permissionHelper.canUsePackageFeature(user.uuid);
            const isSuperAdmin = permissionHelper.isSuperAdmin(user.uuid);
            const isBusinessAdmin = permissionHelper.isBusinessAdmin(user.uuid);
            const visibleModules = permissionHelper.getVisibleModules(user.uuid);
            
            resultsDiv.innerHTML = `
                <div class="result-item ${canPackage ? 'result-success' : 'result-error'}">
                    <span>專案打包功能</span>
                    <span>${canPackage ? '✅ 可使用' : '❌ 無權限'}</span>
                </div>
                <div class="result-item ${isSuperAdmin ? 'result-success' : ''}">
                    <span>超級管理員</span>
                    <span>${isSuperAdmin ? '✅ 是' : '❌ 否'}</span>
                </div>
                <div class="result-item ${isBusinessAdmin ? 'result-success' : ''}">
                    <span>商務管理員</span>
                    <span>${isBusinessAdmin ? '✅ 是' : '❌ 否'}</span>
                </div>
                <div class="result-item">
                    <span>可見模組數量</span>
                    <span>${visibleModules.length} 個</span>
                </div>
            `;
            
            sectionDiv.style.display = 'block';
        }

        function getRoleLevel(role) {
            const levels = {
                'SUPER_ADMIN': '100 (最高權限)',
                'BUSINESS_ADMIN': '50 (商務權限)',
                'GENERAL_USER': '10 (基本權限)'
            };
            return levels[role] || '未知';
        }

        function hideTestResults() {
            document.getElementById('login-results').style.display = 'none';
            document.getElementById('module-access').style.display = 'none';
            document.getElementById('permission-tests').style.display = 'none';
        }

        // 頁面載入時初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🎮 使用者體驗測試頁面已載入');
            console.log('💡 點擊使用者卡片開始測試登入流程');
        });
    </script>
</body>
</html>