<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>快速修復登入</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
</head>
<body>
    <h1>修復 index.html 的登入問題</h1>
    <p>這個頁面會自動修改 index.html，移除動態模組載入的問題。</p>
    
    <button onclick="fixIndexHTML()">點擊修復 index.html</button>
    <pre id="result"></pre>
    
    <script>
        async function fixIndexHTML() {
            const result = document.getElementById('result');
            result.textContent = '修復中...\n';
            
            try {
                // 讀取現有的 index.html
                const response = await fetch('/index.html');
                let htmlContent = await response.text();
                
                // 找到需要替換的部分
                const oldFetchUsers = `        // 從雲端載入使用者 - 使用新的認證系統
        async function fetchUsersFromCloud() {
            try {
                // 使用新的認證系統
                const { loadUsers } = await import('./modules/auth.js');
                const users = await loadUsers();
                
                return users.map(user => ({
                    ...user,
                    icon: user.role === 'admin' ? 'icon-admin' : 'icon-manager'
                }));
            } catch (error) {
                console.error('載入用戶失敗:', error);
                return defaultUsers;
            }
        }`;
                
                const newFetchUsers = `        // 從雲端載入使用者 - 直接從 Supabase
        async function fetchUsersFromCloud() {
            try {
                const USERS_STORAGE_UUID = '550e8400-e29b-41d4-a716-446655440001';
                
                if (!sb) {
                    console.log('Supabase 未初始化，使用預設資料');
                    return defaultUsers;
                }
                
                const { data, error } = await sb
                    .from('user_data')
                    .select('*')
                    .eq('user_id', USERS_STORAGE_UUID)
                    .eq('module', 'users')
                    .single();

                if (error) {
                    console.error('載入使用者失敗:', error);
                    return defaultUsers;
                }

                if (data && Array.isArray(data.data)) {
                    console.log('成功載入使用者:', data.data.length, '位');
                    
                    // 確保每個使用者都有完整資料
                    const users = data.data.map(user => ({
                        ...user,
                        uuid: user.uuid || genUUID(),
                        password: user.password || 'pass1234',
                        display_name: user.display_name || user.username,
                        icon: user.role === 'admin' ? 'icon-admin' : 'icon-manager'
                    }));
                    
                    return users;
                }

                return defaultUsers;
            } catch (error) {
                console.error('載入用戶失敗:', error);
                return defaultUsers;
            }
        }`;

                // 替換 fetchUsersFromCloud
                if (htmlContent.includes(oldFetchUsers)) {
                    htmlContent = htmlContent.replace(oldFetchUsers, newFetchUsers);
                    result.textContent += '✅ 已修復 fetchUsersFromCloud 函數\n';
                } else {
                    result.textContent += '⚠️ 找不到原始的 fetchUsersFromCloud，嘗試其他方式...\n';
                }
                
                // 找到 handleLogin 函數並替換
                const oldHandleLogin = `            try {
                // 動態導入 auth 模組
                const { validateLogin } = await import('./modules/auth.js');
                const result = await validateLogin(selectedUser.username, password);
                
                if (result.success) {
                    // 跳轉到儀表板（使用原本的方式）
                    window.location.href = './dashboard.html';
                } else {
                    showError(result.message);
                }
            } catch (error) {
                console.error('登入錯誤:', error);
                showError('登入失敗，請稍後再試');
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = '登入';
            }`;
                
                const newHandleLogin = `            try {
                // 直接驗證登入（不使用模組）
                const users = await fetchUsersFromCloud();
                const user = users.find(u => 
                    u.username && u.username.toLowerCase() === selectedUser.username.toLowerCase()
                );
                
                if (!user) {
                    showError('找不到此使用者');
                    loginBtn.disabled = false;
                    loginBtn.textContent = '登入';
                    return;
                }
                
                if (!user.password || user.password !== password) {
                    showError('密碼錯誤');
                    loginBtn.disabled = false;
                    loginBtn.textContent = '登入';
                    return;
                }
                
                // 登入成功，儲存資訊
                const loginData = {
                    uuid: user.uuid,
                    display_name: user.display_name,
                    role: user.role,
                    username: user.username,
                    title: user.title,
                    loginTime: Date.now(),
                    expireTime: Date.now() + (7 * 24 * 60 * 60 * 1000)
                };
                
                // 儲存到 localStorage
                localStorage.setItem('gamelife_auth', JSON.stringify(loginData));
                
                // 儲存到 sessionStorage（相容舊版）
                sessionStorage.setItem('user_uuid', user.uuid);
                sessionStorage.setItem('display_name', user.display_name);
                sessionStorage.setItem('role', user.role);
                sessionStorage.setItem('username', user.username);
                sessionStorage.setItem('title', user.title);
                
                console.log('登入成功:', user.username);
                
                // 跳轉到儀表板
                window.location.href = './dashboard.html';
                
            } catch (error) {
                console.error('登入錯誤:', error);
                showError('登入失敗，請稍後再試');
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = '登入';
            }`;
                
                if (htmlContent.includes(oldHandleLogin)) {
                    htmlContent = htmlContent.replace(oldHandleLogin, newHandleLogin);
                    result.textContent += '✅ 已修復 handleLogin 函數\n';
                } else {
                    result.textContent += '⚠️ 找不到原始的 handleLogin，可能格式不同\n';
                }
                
                // 建立 Blob 並下載
                const blob = new Blob([htmlContent], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'index-fixed.html';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                result.textContent += '\n✅ 已下載 index-fixed.html\n';
                result.textContent += '\n請將 index-fixed.html 改名為 index.html 來使用修復版本';
                
            } catch (error) {
                result.textContent = '錯誤: ' + error.message;
            }
        }
    </script>
</body>
</html>