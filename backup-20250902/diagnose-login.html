<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>診斷登入問題</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #0f0;
        }
        button {
            background: #0f0;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover {
            background: #0a0;
        }
        pre {
            background: #000;
            padding: 15px;
            border: 1px solid #0f0;
            overflow: auto;
            white-space: pre-wrap;
        }
        .error { color: #f00; }
        .warning { color: #ff0; }
        .success { color: #0f0; }
    </style>
</head>
<body>
    <h1>🔍 診斷登入問題</h1>
    
    <button onclick="checkUsers()">1. 檢查使用者資料</button>
    <button onclick="testLogin('william')">2. 測試 William 登入</button>
    <button onclick="testLogin('carson')">3. 測試 Carson 登入</button>
    <button onclick="testLogin('KAI')">4. 測試 KAI 登入</button>
    <button onclick="fixPasswords()">5. 修復密碼（設為 pass1234）</button>
    
    <pre id="output">請點擊按鈕開始診斷...</pre>

    <script>
        // Supabase 設定
        const SUPABASE_URL = 'https://jjazipnkoccgmbpccalf.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqYXppcG5rb2NjZ21icGNjYWxmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0MDMxOTIsImV4cCI6MjA3MTk3OTE5Mn0.jHH2Jf-gbx0UKqvUgxG-Nx2f_QwVqZBOFqtbAxzYvnY';
        const USERS_STORAGE_UUID = '550e8400-e29b-41d4-a716-446655440001';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const output = document.getElementById('output');
        
        // 載入使用者
        async function loadUsers() {
            try {
                const { data, error } = await supabase
                    .from('user_data')
                    .select('*')
                    .eq('user_id', USERS_STORAGE_UUID)
                    .eq('module', 'users')
                    .single();

                if (error) {
                    throw error;
                }

                if (data && Array.isArray(data.data)) {
                    return data.data;
                }

                return [];
            } catch (error) {
                console.error('載入使用者失敗:', error);
                throw error;
            }
        }
        
        // 檢查使用者資料
        async function checkUsers() {
            output.innerHTML = '檢查使用者資料...\n\n';
            
            try {
                const users = await loadUsers();
                output.innerHTML += `<span class="success">找到 ${users.length} 個使用者：</span>\n\n`;
                
                users.forEach((user, index) => {
                    output.innerHTML += `<span class="warning">${index + 1}. ${user.display_name || user.username}</span>\n`;
                    output.innerHTML += `   帳號: ${user.username}\n`;
                    output.innerHTML += `   UUID: ${user.uuid ? 
                        `<span class="success">${user.uuid}</span>` : 
                        '<span class="error">無 UUID！需要生成</span>'}\n`;
                    output.innerHTML += `   密碼: ${user.password ? 
                        `<span class="success">已設定</span> (值: "${user.password}")` : 
                        '<span class="error">無密碼欄位！</span>'}\n`;
                    output.innerHTML += `   角色: ${user.role}\n`;
                    output.innerHTML += `   職稱: ${user.title || '未設定'}\n\n`;
                });
                
                // 診斷問題
                output.innerHTML += '\n<span class="warning">=== 診斷結果 ===</span>\n';
                let hasProblems = false;
                
                users.forEach(user => {
                    const problems = [];
                    
                    if (!user.password) {
                        problems.push('沒有密碼欄位');
                    } else if (user.password !== 'pass1234') {
                        problems.push(`密碼是 "${user.password}" 不是 "pass1234"`);
                    }
                    
                    if (!user.uuid) {
                        problems.push('沒有 UUID');
                    }
                    
                    if (problems.length > 0) {
                        hasProblems = true;
                        output.innerHTML += `\n<span class="error">${user.username}:</span>\n`;
                        problems.forEach(p => {
                            output.innerHTML += `  - ${p}\n`;
                        });
                    }
                });
                
                if (!hasProblems) {
                    output.innerHTML += '<span class="success">✅ 所有使用者資料都正常</span>\n';
                } else {
                    output.innerHTML += '\n<span class="warning">💡 建議：點擊 "5. 修復密碼" 按鈕來修正問題</span>\n';
                }
                
            } catch (error) {
                output.innerHTML += `<span class="error">錯誤: ${error.message}</span>\n`;
            }
        }
        
        // 測試登入
        async function testLogin(username) {
            output.innerHTML = `測試登入 ${username}...\n\n`;
            
            try {
                const users = await loadUsers();
                const user = users.find(u => 
                    u.username && u.username.toLowerCase() === username.toLowerCase()
                );
                
                if (!user) {
                    output.innerHTML += `<span class="error">❌ 找不到使用者 ${username}</span>\n`;
                    return;
                }
                
                output.innerHTML += `找到使用者:\n`;
                output.innerHTML += `- 顯示名稱: ${user.display_name || user.username}\n`;
                output.innerHTML += `- 帳號: ${user.username}\n`;
                output.innerHTML += `- 密碼欄位: ${user.password ? `存在 (值: "${user.password}")` : '不存在'}\n`;
                output.innerHTML += `- UUID: ${user.uuid || '無'}\n\n`;
                
                output.innerHTML += `嘗試用密碼 'pass1234' 登入...\n`;
                
                // 模擬登入驗證
                if (!user.password) {
                    output.innerHTML += `<span class="error">❌ 登入失敗：使用者沒有密碼欄位</span>\n`;
                } else if (user.password !== 'pass1234') {
                    output.innerHTML += `<span class="error">❌ 登入失敗：密碼不正確</span>\n`;
                    output.innerHTML += `<span class="warning">   實際密碼是: "${user.password}"</span>\n`;
                } else {
                    output.innerHTML += `<span class="success">✅ 登入成功！</span>\n`;
                    if (user.uuid) {
                        output.innerHTML += `   UUID: ${user.uuid}\n`;
                    }
                }
                
            } catch (error) {
                output.innerHTML += `<span class="error">錯誤: ${error.message}</span>\n`;
            }
        }
        
        // 修復密碼
        async function fixPasswords() {
            output.innerHTML = '修復所有使用者密碼...\n\n';
            
            try {
                const users = await loadUsers();
                let modified = false;
                
                output.innerHTML += '檢查並修復每個使用者:\n';
                
                const fixedUsers = users.map(user => {
                    output.innerHTML += `\n${user.username}:\n`;
                    
                    // 修復密碼
                    if (!user.password || user.password !== 'pass1234') {
                        output.innerHTML += `  <span class="warning">- 設定密碼為 pass1234</span>\n`;
                        user.password = 'pass1234';
                        modified = true;
                    } else {
                        output.innerHTML += `  <span class="success">- 密碼已經是 pass1234</span>\n`;
                    }
                    
                    // 修復 UUID
                    if (!user.uuid) {
                        const newUUID = crypto.randomUUID ? crypto.randomUUID() : 
                            'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                                const r = Math.random() * 16 | 0;
                                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                                return v.toString(16);
                            });
                        output.innerHTML += `  <span class="warning">- 生成 UUID: ${newUUID}</span>\n`;
                        user.uuid = newUUID;
                        modified = true;
                    } else {
                        output.innerHTML += `  <span class="success">- UUID 已存在</span>\n`;
                    }
                    
                    // 確保有顯示名稱
                    if (!user.display_name) {
                        user.display_name = user.username;
                        modified = true;
                    }
                    
                    return user;
                });
                
                if (modified) {
                    output.innerHTML += '\n\n儲存修復後的資料到 Supabase...\n';
                    
                    const { data, error } = await supabase
                        .from('user_data')
                        .upsert({
                            user_id: USERS_STORAGE_UUID,
                            module: 'users',
                            data: fixedUsers,
                            updated_at: new Date().toISOString()
                        }, {
                            onConflict: 'user_id,module'
                        });

                    if (error) {
                        output.innerHTML += `<span class="error">❌ 儲存失敗: ${error.message}</span>\n`;
                    } else {
                        output.innerHTML += '<span class="success">✅ 修復完成！所有使用者密碼都已設為 pass1234</span>\n';
                        output.innerHTML += '\n請重新整理 index.html 並嘗試登入\n';
                    }
                } else {
                    output.innerHTML += '\n<span class="success">✅ 所有使用者資料都正常，不需要修復</span>\n';
                }
                
            } catch (error) {
                output.innerHTML += `<span class="error">錯誤: ${error.message}</span>\n`;
            }
        }
        
        // 測試連線
        window.onload = async function() {
            output.innerHTML = '測試 Supabase 連線...\n';
            try {
                const { data, error } = await supabase
                    .from('user_data')
                    .select('count')
                    .limit(1);
                
                if (error) {
                    output.innerHTML += `<span class="error">連線失敗: ${error.message}</span>\n`;
                } else {
                    output.innerHTML += '<span class="success">✅ Supabase 連線正常</span>\n';
                    output.innerHTML += '\n請點擊按鈕開始診斷...\n';
                }
            } catch (err) {
                output.innerHTML += `<span class="error">連線錯誤: ${err.message}</span>\n`;
            }
        };
    </script>
</body>
</html>